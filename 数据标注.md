# 数据标注
## 环境准备
### 使用conda安装label studio
 ```cmd
conda create --name label-studio python==3.11
conda activate label-studio
conda install psycopg2 -y
pip install label-studio
 ```

### 设置环境变量

#### 本地存储
##### windows
```cmd
set LABEL_STUDIO_LOCAL_FILES_DOCUMENT_ROOT=D:\
set LABEL_STUDIO_LOCAL_FILES_SERVING_ENABLED=true
```
##### linux
```bash
export LABEL_STUDIO_LOCAL_FILES_DOCUMENT_ROOT=/
export LABEL_STUDIO_LOCAL_FILES_SERVING_ENABLED=true
```

## 开始标注
### 运行

```cmd
label-studio start
```

打开浏览器地址，默认地址为[label-studio](http://localhost:8080)

### 创建标注项目

1. 点击create 创建标注项目 ![Pasted image 20251216092827](https://raw.githubusercontent.com/AlexSCT/Pictures/master/Pasted%20image%2020251216092827.png)
2. 填写项目信息后保存 ![Pasted image 20251216092931](https://raw.githubusercontent.com/AlexSCT/Pictures/master/Pasted%20image%2020251216092931.png)
3. 点击settings 进入项目设置 ![Pasted image 20251216093201](https://raw.githubusercontent.com/AlexSCT/Pictures/master/Pasted%20image%2020251216093201.png) ![Pasted image 20251216093642](https://raw.githubusercontent.com/AlexSCT/Pictures/master/Pasted%20image%2020251216093642.png)

## 项目设置

### Labeling Interface
![Pasted image 20251216093819](https://raw.githubusercontent.com/AlexSCT/Pictures/master/Pasted%20image%2020251216093819.png)
![Pasted image 20251216093835](https://raw.githubusercontent.com/AlexSCT/Pictures/master/Pasted%20image%2020251216093835.png)
##### 目标检测示例
```xml
<View>
  <Image name="image" value="$image"/>
  <RectangleLabels name="label" toName="image">
    <Label value="Airplane" background="green"/>
    <Label value="Car" background="blue"/>
  </RectangleLabels>
</View>
```
#### Cloud Storage
##### 选择数据
![Pasted image 20251216094112](https://raw.githubusercontent.com/AlexSCT/Pictures/master/Pasted%20image%2020251216094112.png)
#### 填写数据路径
![Pasted image 20251216094430](https://raw.githubusercontent.com/AlexSCT/Pictures/master/Pasted%20image%2020251216094430.png)
![Pasted image 20251216094606](https://raw.githubusercontent.com/AlexSCT/Pictures/master/Pasted%20image%2020251216094606.png)
#### 设置导入格式
导入图片数据的话，使用Files方法，根据每个图片创建对应的标注task
![Pasted image 20251216094655](https://raw.githubusercontent.com/AlexSCT/Pictures/master/Pasted%20image%2020251216094655.png)
#### 保存设置
![Pasted image 20251216094717](https://raw.githubusercontent.com/AlexSCT/Pictures/master/Pasted%20image%2020251216094717.png)
![Pasted image 20251216094904](https://raw.githubusercontent.com/AlexSCT/Pictures/master/Pasted%20image%2020251216094904.png)
### 数据管理
![Pasted image 20251216095421](https://raw.githubusercontent.com/AlexSCT/Pictures/master/Pasted%20image%2020251216095421.png)

## 后端服务

### 安装
``` shell
git clone https://github.com/HumanSignal/label-studio-ml-backend.git
cd label-studio-ml-backend/
pip install -e .
```
### 设置
#### API Key(PAT)获取
##### 进入账户设置
![Pasted image 20251216100356](https://raw.githubusercontent.com/AlexSCT/Pictures/master/Pasted%20image%2020251216100356.png)
##### 创建PAT
![Pasted image 20251216100428](https://raw.githubusercontent.com/AlexSCT/Pictures/master/Pasted%20image%2020251216100428.png)

#### 环境变量
```bash
LABEL_STUDIO_API_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoicmVmcmVzaCIsImV4cCI6ODA3MjYyNDg2NCwiaWF0IjoxNzY1NDI0ODY0LCJqdGkiOiJhMTY3OTEwMzRjNDA0NjI1OTFhNjIwYzhiODRhNzliNCIsInVzZXJfaWQiOiIxIn0.AtTentt2loqDlyqhR1W-eyEr-cSYfoPnlJJGY9q14Zs  
LABEL_STUDIO_LOCAL_FILES_SERVING_ENABLED=true  
LABEL_STUDIO_LOCAL_FILES_DOCUMENT_ROOT=/  
LABEL_STUDIO_URL=http://localhost:8080
```

#### 添加自定义模型
将模型文件放入models文件夹
### 运行
#### 直接运行
```sh
cd label_studio_ml/examples/yolo
pip install -r requirements.txt
pip install -r requirements_base.txt
sh start.sh
```

### 设置项目
#### 进入model设置
![Pasted image 20251216100628](https://raw.githubusercontent.com/AlexSCT/Pictures/master/Pasted%20image%2020251216100628.png)
#### 设置model
![Pasted image 20251216100659](https://raw.githubusercontent.com/AlexSCT/Pictures/master/Pasted%20image%2020251216100659.png)
#### 设置完成
![Pasted image 20251216100710](https://raw.githubusercontent.com/AlexSCT/Pictures/master/Pasted%20image%2020251216100710.png)

#### 更新项目标注设置
##### 示例
```xml
<View>
  <Image name="image" value="$image"/>
  <RectangleLabels name="label" toName="image"
                model_path="PVDefect_V.pt" 
          		model_score_threshold="0.3">
    <Label value="ComponentMissing" background="green"/>
    <Label value="ComponentNotWorking" background="blue"/>
  	<Label value="GrassBlocking" background="#FFA39E"/>
    <Label value="ObjectBlocking" background="#D4380D"/>
    <Label value="WireShadow" background="#FFC069"/>
    <Label value="DustAccumulation" background="#AD8B00"/>
  </RectangleLabels>
</View>
```

#### 开始标注
##### 效果示例
![Pasted image 20251216101524](https://raw.githubusercontent.com/AlexSCT/Pictures/master/Pasted%20image%2020251216101524.png)

## 数据导出
### 网页导出
![Pasted image 20251216102620](https://raw.githubusercontent.com/AlexSCT/Pictures/master/Pasted%20image%2020251216102620.png)
![Pasted image 20251216102653](https://raw.githubusercontent.com/AlexSCT/Pictures/master/Pasted%20image%2020251216102653.png)
### sdk导出

```shell
python3 /mnt/d/Code/label-studio-export/export_yolo.py --project-id 2
python3 /mnt/d/Code/label-studio-export/split.py
```

#### export_yolo.py
``` python
"""  
This is a Python script that exports labeled data from a Label Studio project  
and converts it into the YOLO format, including downloading associated images.  
  
## 1. What It Does and How  
The script performs the following steps:  
  
1. **Connects to Label Studio:** It uses the Label Studio SDK to connect  
to a Label Studio instance using the provided URL and API key.  
2. **Retrieves the Project:** Fetches the specified project by its ID.  
3. **Creates an Export Snapshot:** Generates a snapshot of the project's annotations for export.  
4. **Downloads Annotations:** Downloads the annotations in JSON format.  
5. **Converts Annotations to YOLO Format:** Utilizes the Label Studio Converter  
to transform the annotations into the YOLO format suitable for object detection tasks.  
6. **Downloads Associated Images:** Iterates over the exported tasks and downloads the corresponding images,  
implementing retry logic with exponential backoff to handle rate limits or transient network issues.  
  
## 2. How to Use It  
  
1. **Install Dependencies:** Ensure you have Python installed along with the required packages:  
   ```bash   pip install git+https://github.com/heartexlabs/label-studio-sdk.git tqdm   ```  
2. **Set Up Credentials:** Provide your LABEL_STUDIO_URL, LABEL_STUDIO_API_KEY, and PROJECT_ID either  
by modifying the script variables or via command-line arguments.  
  
3. **Run the Script:** Execute the script from the terminal:  
   ```bash   python script.py --url 'https://app.humansignal.com' --api-key 'your-api-key' --project-id 12345   ```   Replace `'your-api-key'` and `12345` with your actual API key and project ID.  
4. **Output:** The script will create an `output_yolo` directory containing:  
   - YOLO-formatted annotation files.   - An `images` subdirectory with all the downloaded images.  
## 3. When to Use It  
Use this script when you need to prepare labeled datasets from Label Studio for training YOLO object detection models.  
It's particularly useful for converting annotations into the required YOLO format and ensuring all associated images  
are downloaded and organized locally for your machine learning pipeline.  
"""  
  
import argparse  
import os  
import time  
import json  
import shutil  
import logging  
  
from label_studio_sdk.data_manager import Filters, Operator, Type, Column  
from tqdm import tqdm  
from label_studio_sdk.client import LabelStudio  
import os  
from label_studio_sdk.converter import Converter  
from label_studio_sdk._extensions.label_studio_tools.core.utils.io import get_local_path  
  
  
LABEL_STUDIO_URL = os.getenv('LABEL_STUDIO_URL', 'http://localhost:8080')  
LABEL_STUDIO_API_KEY = os.getenv('LABEL_STUDIO_API_KEY')  
PROJECT_ID = int(os.getenv('PROJECT_ID', '2'))  
  
logger = logging.getLogger(__name__)  
logging.basicConfig(level=logging.INFO, format='%(asctime)s [%(levelname)s] [%(module)s] - %(message)s')  
  
  
def prepare_export(ls: LabelStudio, project_id: int, view_id: int | None = None):  
    logger.info("Creating export snapshot for project.")  
    create_kwargs = {"title": "YOLO Export Snapshot"}  
    if view_id is not None:  
        create_kwargs["task_filter_options"] = {"view": view_id}  
  
    export = ls.projects.exports.create(project_id, **create_kwargs)  
    while export.status == 'in_progress':  
        time.sleep(3)  
        export = ls.projects.exports.get(id=project_id, export_pk=export.id)  
    data_iter = ls.projects.exports.download(id=project_id, export_pk=export.id, export_type='JSON')  
  
    snapshot_path = os.path.abspath(f"project_{project_id}_yolo_export.json")  
    with open(snapshot_path, "wb") as f:  
        for data in data_iter:  
            f.write(data)  
    with open(snapshot_path) as f:  
        exported_tasks = json.load(f)  
    logger.info(f"Export snapshot saved to {snapshot_path}.")  
    return snapshot_path, exported_tasks  
  
  
def run(url: str, api_key: str, project_id: int):  
    logger.info("Connecting to Label Studio.")  
    ls = LabelStudio(base_url=url, api_key=api_key)  
    logger.info("Connected to Label Studio successfully.")  
  
    logger.info(f"Retrieving project with ID: {project_id}.")  
    project = ls.projects.get(id=project_id)  
  
    logger.info("Downloading export snapshot and loading exported tasks.")  
    filters = Filters.create(  
        Filters.AND,[  
            Filters.item(  
                Column.total_annotations,  
                Operator.GREATER,  
                Type.Number,  
                Filters.value(0)  
            )  
        ]  
    )  
    view = ls.views.create(project=project_id, data={'filters': filters})  
    snapshot_path, exported_tasks = prepare_export(ls, project_id, view.id)  
  
    logger.info("Initializing Converter with labeling config.")  
    label_config = project.label_config  
    converter = Converter(config=label_config, project_dir=os.path.dirname(snapshot_path), download_resources=False)  
  
    logger.info("Converting to YOLO format.")  
    output_dir = 'export_yolo'  
    converter.convert_to_yolo(input_data=snapshot_path, output_dir=output_dir, is_dir=False)  
  
    logger.info("Creating directory for YOLO images.")  
    yolo_images_dir = os.path.join(output_dir, 'images')  
    os.makedirs(yolo_images_dir, exist_ok=True)  
  
    logger.info("Downloading images for exported tasks.")  
    for task in tqdm(exported_tasks):  
        image_url = next(iter(task['data'].values()))  
        if image_url:  
            max_retries = 1  
            retry_delay = 1  # initial delay in seconds  
            for attempt in range(1, max_retries + 1):  
                try:  
                    local_image_path = get_local_path(  
                        url=image_url,  
                        hostname=url,  
                        access_token=api_key,  
                        task_id=task['id'],  
                        download_resources=True  
                    )  
                    name = os.path.basename(local_image_path).split('__', 1)[-1]  
                    destination_path = os.path.join(yolo_images_dir, name)  
                    shutil.copy2(local_image_path, destination_path)  
                    logger.info(f"Copied image {local_image_path} to {destination_path}")  
                    break  # Break the retry loop if download is successful  
                except Exception as e:  
                    logger.error(f"Error downloading image for task {task['id']}: {e}")  
                    if attempt < max_retries:  
                        sleep_time = retry_delay * (2 ** (attempt - 1))  # Exponential backoff  
                        logger.info(f"Retrying in {sleep_time} seconds... (Attempt {attempt}/{max_retries})")  
                        time.sleep(sleep_time)  
                    else:  
                        logger.error(f"Failed to download image for task {task['id']} after {max_retries} attempts.")  
        else:  
            logger.warning(f"No image URL found for task {task['id']}")  
    logger.info("YOLO export with images completed successfully.")  
  
    return True  
  
def parse_arguments():  
    parser = argparse.ArgumentParser(  
        description='YOLO Export Script for Label Studio'  
    )  
    parser.add_argument(  
        '--url',  
        type=str,  
        default=os.getenv('LABEL_STUDIO_URL', LABEL_STUDIO_URL),  
        help='Label Studio URL',  
    )  
    parser.add_argument(  
        '--api-key',  
        type=str,  
        default=os.getenv('LABEL_STUDIO_API_KEY', LABEL_STUDIO_API_KEY),  
        help='Label Studio API Key',  
    )  
    parser.add_argument(  
        '--project-id',  
        type=int,  
        default=int(os.getenv('PROJECT_ID', PROJECT_ID)),  
        help='Label Studio Project ID',  
    )  
    return parser.parse_args()  
  
  
if __name__ == "__main__":  
    args = parse_arguments()  
    run(args.url, args.api_key, args.project_id)
```

#### split.py
```python
import os  
import shutil  
import random  
from pathlib import Path  
  
  
def split_yolo_dataset(src_dir="export_yolo", ratios=(0.7, 0.2, 0.1)):  
    """  
    参数说明：  
    src_dir: 原始数据集目录（需要包含images和labels子目录）  
    ratios: 训练/验证/测试集比例（建议总和为1）  
    """  
    # 创建备份目录  
    dst_dir = f"{src_dir}_split"  
    if os.path.exists(dst_dir):  
        shutil.rmtree(dst_dir)  
  
    # 创建标准目录结构  
    base_path = Path(dst_dir)  
    (base_path / "images").mkdir(parents=True)  
    (base_path / "labels").mkdir(parents=True)  
  
    # 复制原始文件  
    shutil.copytree(Path(src_dir) / "images", base_path / "images" / "original")  
    shutil.copytree(Path(src_dir) / "labels", base_path / "labels" / "original")  
    shutil.copy(Path(src_dir) / "classes.txt", base_path)  
    if (Path(src_dir) / "notes.json").exists():  
        shutil.copy(Path(src_dir) / "notes.json", base_path)  
  
    # 获取所有图像文件名（不带扩展名）  
    all_images = [f.stem for f in (base_path / "images/original").glob("*.*")  
                  if f.suffix.lower() in ['.jpg', '.png', '.jpeg']]  
    random.shuffle(all_images)  # 随机打乱顺序  
  
    # 计算分割点  
    total = len(all_images)  
    train_end = int(ratios[0] * total)  
    val_end = train_end + int(ratios[1] * total)  
  
    # 划分数据集  
    splits = {  
        "train": all_images[:train_end],  
        "val": all_images[train_end:val_end],  
        "test": all_images[val_end:]  
    }  
  
    # 创建目标目录结构  
    for split in splits:  
        (base_path / "images" / split).mkdir()  
        (base_path / "labels" / split).mkdir()  
  
    # 移动文件到对应目录  
    for split, files in splits.items():  
        for fname in files:  
            # 处理图像文件  
            src_img = next((base_path / "images/original").glob(f"{fname}.*"))  
            dst_img = base_path / "images" / split / src_img.name  
            shutil.move(str(src_img), str(dst_img))  
  
            # 处理标注文件  
            src_label = base_path / "labels/original" / f"{fname}.txt"  
            dst_label = base_path / "labels" / split / src_label.name  
            if src_label.exists():  
                shutil.move(str(src_label), str(dst_label))  
            else:  
                print(f"警告：缺失标注文件 {src_label}")  
  
    # 清理原始目录  
    shutil.rmtree(base_path / "images/original")  
    shutil.rmtree(base_path / "labels/original")  
  
    print(f"数据集已分割到 {dst_dir}")  
    print(f"最终目录结构：")  
    print(f"images/")  
    print(f"├── train/ : {len(splits['train'])} 图像")  
    print(f"├── val/   : {len(splits['val'])} 图像")  
    print(f"└── test/  : {len(splits['test'])} 图像")  
    print(f"labels/")  
    print(f"├── train/ : {len(splits['train'])} 标注")  
    print(f"├── val/   : {len(splits['val'])} 标注")  
    print(f"└── test/  : {len(splits['test'])} 标注")  
  
  
if __name__ == "__main__":  
    split_yolo_dataset()
```